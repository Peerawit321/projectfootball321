<!DOCTYPE html>
<html lang="th">   
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-image: url('https://wipelectric.com/wp-content/uploads/2021/06/Ref-Trinoi1.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 100vh;
            font-family: 'Montserrat', sans-serif;
        }

        .content-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            max-width: 1000px;
            margin: auto;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .table-auto th,
        .table-auto td {
            text-align: center;
        }
        
    </style>
     
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
</head>

<body data-user-id="{{ request.user.id }}" class="bg-gray-100 py-10 px-4">
    <div class="content-container">
        <div class="flex items-center bg-gray-800 p-4 rounded-lg mb-5">
            <div class="flex-grow text-center">
                <a href="{% url 'profile_view' %}"
                    class="text-white mx-4 font-bold border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-600">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
                <a href="{% url 'home' %}"
                    class="text-white mx-4 font-bold border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-600">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <a href="{% url 'about' %}"
                    class="text-white mx-4 font-bold border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-600">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏ô‡∏≤‡∏°</a>
                <a href="{% url 'bookings' %}"
                    class="text-white mx-4 font-bold border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-600">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</a>
                <a href="{% url 'contact' %}"
                    class="text-white mx-4 font-bold border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-600">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a>
                <a href="{% url 'logout' %}"
                    class="text-white mx-4 font-bold border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>  
            </div>
        </div>

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6"></h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            {% for field in fields %}
            <div class="bg-white shadow-lg rounded-lg p-4 text-center">
                <img src="{{ field.image.url }}" alt="{{ field.field_name }}"
                    class="w-full h-40 object-cover rounded-lg">
                <h3 class="text-lg mt-3 font-semibold">{{ field.field_name }}</h3>
                <p class="text-gray-600">Weekday: ‡∏ø{{ field.price_weekday }}</p>
                <p class="text-gray-600">Weekend: ‡∏ø{{ field.price_weekend }}</p>
            </div>
            {% endfor %}
        </div>

 <!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">

<!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
<div class="flex justify-center">
    <button id="toggleCalendar" class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition">
        <i class="fas fa-calendar-alt text-lg mr-2"></i> <span id="calendarButtonText">‡∏î‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°</span>
    </button>
</div>

<!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
<div id="calendarContainer" class="bg-white shadow-lg rounded-lg p-6 mt-5 border border-green-500 hidden">
    <h2 class="text-xl font-bold text-green-700 text-center mb-4">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°</h2>
    <div id="calendar"></div>
</div>

<h1 class="bg-red-100 text-red-700 border border-red-400 rounded-md px-6 py-4 text-center text-xl font-semibold shadow-md max-w-xl mx-auto mt-6">
    ‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 30 ‡∏ô‡∏≤‡∏ó‡∏µ
</h1>

<!-- FullCalendar CSS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
         document.getElementById("bookFieldButton").addEventListener("click", function(event) {
                let now = new Date(); // ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                let selectedTime = new Date(); // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
                selectedTime.setMinutes(selectedTime.getMinutes() + 20); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ

                let diffMinutes = Math.floor((selectedTime - now) / (1000 * 60)); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ

                if (diffMinutes < 30) {
                    document.getElementById("bookingWarning").classList.remove("hidden"); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                 } else {
                     document.getElementById("bookingWarning").classList.add("hidden"); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    }
                });
            });

        document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.getElementById("toggleCalendar");
        const calendarContainer = document.getElementById("calendarContainer");
        const calendarButtonText = document.getElementById("calendarButtonText");
        let calendar;  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• FullCalendar

        // üöÄ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
        toggleButton.addEventListener("click", function () {
            if (calendarContainer.classList.contains("hidden")) {
                calendarContainer.classList.remove("hidden");
                calendarButtonText.textContent = "‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°";
                if (!calendar) {
                    loadCalendar();  // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î
                }
            } else {
                calendarContainer.classList.add("hidden");
                calendarButtonText.textContent = "‡∏î‡∏π‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°";
            }
        });

        function loadCalendar() {
            let calendarEl = document.getElementById("calendar");
            let today = new Date().toISOString().split("T")[0];

            fetch("/api/bookings/")
                .then(response => response.json())
                .then(data => {
                    console.log("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API:", data);

                    let events = data.map(booking => ({
                        title: `üë§ ${booking.user} | üèü ${booking.field}`,
                        start: `${booking.booking_date}T${booking.start_time}`,
                        end: `${booking.booking_date}T${booking.end_time}`,
                        backgroundColor: "#16a34a",  // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                        borderColor: "#15803d",
                        extendedProps: {
                            user: booking.user,
                            field: booking.field,
                            start_time: booking.start_time,
                            end_time: booking.end_time
                        }
                    }));

                    // üîπ ‡∏™‡∏£‡πâ‡∏≤‡∏á FullCalendar
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: "dayGridMonth",
                        locale: "th",
                        height: 600,
                        validRange: { start: today },
                        events: events,

                        // üöÄ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        eventClick: function(info) {
                            alert(`üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á\n\nüë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${info.event.extendedProps.user}\nüèü ‡∏™‡∏ô‡∏≤‡∏°: ${info.event.extendedProps.field}\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${info.event.extendedProps.start_time} - ${info.event.extendedProps.end_time}`);
                        }
                    });

                    console.log("‚úÖ FullCalendar ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß!");
                    calendar.render();
                })
          .catch(error => console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error));
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
    const bookingDate = document.getElementById("id_booking_date");
    const startTime = document.getElementById("id_start_time");
    const endTime = document.getElementById("id_end_time");
    const fieldSelect = document.getElementById("id_field");
    const totalPriceField = document.getElementById("id_total_price");
    const bookingForm = document.querySelector("form");

    // üöÄ ‡∏î‡∏∂‡∏á user_id ‡∏à‡∏≤‡∏Å <body>
    const userId = document.body.getAttribute("data-user-id");

    let existingBookings = [];

    // üöÄ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏î‡∏µ‡∏ï
    const today = new Date().toISOString().split("T")[0];
    bookingDate.setAttribute("min", today);

    startTime.addEventListener("change", calculatePrice);
    endTime.addEventListener("change", calculatePrice);

    // üöÄ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏≤‡∏Å API
    fetchBookings();

    // üöÄ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ user ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    function isUserBanned() {
        let banData = localStorage.getItem(`ban_${userId}`);
        if (banData) {
            let banEndTime = new Date(JSON.parse(banData).banEnd);
            let now = new Date();
            if (now < banEndTime) {
                return true;  // ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 30 ‡∏ô‡∏≤‡∏ó‡∏µ
            } else {
                localStorage.removeItem(`ban_${userId}`);  // ‚úÖ ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                return false;
            }
        }
        return false;
    }

    // üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
    function calculatePrice() {
        // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        if (startTime.value && endTime.value) {
            const start = new Date(`2000-01-01T${startTime.value}`);
            const end = new Date(`2000-01-01T${endTime.value}`);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
            const diffHours = (end - start) / (1000 * 60 * 60);
            
            // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÄ‡∏õ‡πá‡∏ô 500 ‡∏ö‡∏≤‡∏ó
            const hourlyRate = 500;
            const price = diffHours * hourlyRate;
            
            totalPriceField.value = price.toFixed(2);
        }
    }

    // üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    // üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    // üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    function fetchBookings() {
        fetch("/api/bookings/")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏µ‡∏ö‡∏±‡∏Å
                console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:", data);
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ null/undefined
                existingBookings = data.map(b => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                    const userId = b.user_id !== undefined ? b.user_id : (b.user || "unknown");
                    const fieldId = b.field_id !== undefined ? b.field_id : (b.field || "unknown");
                    
                    return {
                        booking_id: b.booking_id || "",
                        user: userId ? userId.toString() : "unknown",
                        field: fieldId ? fieldId.toString() : "unknown",
                        field_name: b.field_name || fieldId.toString() || "unknown",
                        booking_date: b.booking_date,
                        start_time: new Date(`${b.booking_date}T${b.start_time}`),
                        end_time: new Date(`${b.booking_date}T${b.end_time}`)
                    };
                });
                
                console.log("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß:", existingBookings.length, "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            })
            .catch(error => {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:", error);
            });
    }

    // üöÄ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    function processBookings(bookings) {
        existingBookings = bookings.map(b => ({
            booking_id: b.booking_id,
            user: b.user,
            field: b.field,
            booking_date: b.booking_date,
            start_time: new Date(`${b.booking_date}T${b.start_time}`),
            end_time: new Date(`${b.booking_date}T${b.end_time}`)
        }));
    }

    // üöÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
    function checkTimeConflict(field, date, start, end) {
        return existingBookings.some(booking => {
            return (
                booking.field === field &&
                booking.booking_date === date &&
                start < booking.end_time &&
                end > booking.start_time
            );
        });
    }

    // üöÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    bookingForm.addEventListener("submit", function (e) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (isUserBanned()) {
            e.preventDefault();
            alert("‚õî ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ");
            return;
        }

        const selectedField = fieldSelect.options[fieldSelect.selectedIndex].text; // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ ID
        const selectedDate = bookingDate.value;
        const selectedStart = new Date(`${selectedDate}T${startTime.value}`);
        const selectedEnd = new Date(`${selectedDate}T${endTime.value}`);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
        if (selectedStart >= selectedEnd) {
            e.preventDefault();
            alert("‚ùå ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î");
            return;
        }

        // ‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
        const userConflict = existingBookings.some(booking => {
            return (
                booking.user === userId &&
                booking.field === selectedField &&
                booking.booking_date === selectedDate &&
                selectedStart < booking.end_time &&
                selectedEnd > booking.start_time
            );
        });

        if (userConflict) {
            e.preventDefault();
            alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà!");
            return;
        }

        // ‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const otherConflict = existingBookings.some(booking => {
            return (
                booking.field === selectedField &&
                booking.booking_date === selectedDate &&
                selectedStart < booking.end_time &&
                selectedEnd > booking.start_time
            );
        });

        if (otherConflict) {
            e.preventDefault();
            alert("‚ùå ‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô!");
            return;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        //e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏£‡∏¥‡∏á (‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ)
        
        // ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)
        alert("‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");

        // üöÄ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
         // üöÄ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
         setTimeout(() => {
            let failedPayments = parseInt(localStorage.getItem(`failedPayments_${userId}`) || "0");

            failedPayments++;  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢
            localStorage.setItem(`failedPayments_${userId}`, failedPayments);

            if (failedPayments >= 2) {
                // üöÄ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ
                let banEnd = new Date();
                banEnd.setMinutes(banEnd.getMinutes() + 30);
                localStorage.setItem(`ban_${userId}`, JSON.stringify({ banEnd }));

                alert("‚õî ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á! ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ");
        }
        }, 5000); // ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô Event ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô Backend ‡πÑ‡∏î‡πâ)
    });
});
        
    </script>

        <form method="post"
            class="space-y-6 p-6 bg-white rounded-lg shadow-lg max-w-lg mx-auto mt-10 border border-black"
            action="{% url 'bookings' %}">
            {% csrf_token %}
            <div class="space-y-4">
                {{ form.as_p }}
            </div>
            <label for=""></label>
            <button type="submit"
                class="w-full py-3 bg-green-600 text-white rounded-full text-lg font-semibold hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                ‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°
            </button>
        </form>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
            const startTime = document.getElementById("id_start_time");
            const endTime = document.getElementById("id_end_time");
            const totalPriceField = document.getElementById("id_total_price");

            function calculatePrice() {
                if (startTime.value && endTime.value) {
                    let startHour = parseInt(startTime.value.split(":")[0]); 
                    let endHour = parseInt(endTime.value.split(":")[0]);

                    if (endHour > startHour) {
                        let duration = endHour - startHour;
                        let totalPrice = duration * 500;
                        totalPriceField.value = totalPrice;
                    } else {
                        totalPriceField.value = 0;
                    }
                }
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤
            startTime.addEventListener("change", calculatePrice);
            endTime.addEventListener("change", calculatePrice);
        });
            function toggleBookingTable() {
                const table = document.getElementById('bookingTable');
                table.classList.toggle('hidden');
            }

            function confirmBooking() {
                const fieldName = document.getElementById('field_name').value;
                const date = document.getElementById('booking_date').value;
                const time = document.getElementById('booking_time').value;

                if (fieldName && date && time) {
                    alert('‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß!');
                } else {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                }
            }
        </script>
</body>
</html>



